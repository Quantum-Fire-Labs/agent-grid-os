<% if @chat %>
  <%= turbo_stream_from @chat %>
<% end %>

<div class="chat-hub" data-controller="chat-hub" data-chat-hub-has-chat-value="<%= @chat.present? %>">
  <%# ── Sidebar ── %>
  <div class="chat-hub-sidebar" data-chat-hub-target="sidebar">
    <div class="chat-hub-sidebar-header">
      <h2 class="chat-hub-title">Messages</h2>
      <% if Current.user.admin? %>
        <%= button_to "New Group", chats_path, method: :post, class: "btn btn-ghost btn-xs" %>
      <% end %>
    </div>

    <div class="chat-hub-search">
      <input type="search" placeholder="Search chats..." class="chat-hub-search-input" data-chat-hub-target="search" data-action="input->chat-hub#filter" autocomplete="off" />
    </div>

    <div class="chat-hub-conversations" data-chat-hub-target="list">
      <% if @chats.any? %>
        <% @chats.each do |chat| %>
          <%= link_to chat_path(chat),
                class: "chat-hub-convo #{"chat-hub-convo-active" if @chat == chat}",
                data: {
                  chat_hub_target: "chat",
                  name: chat.display_name.downcase,
                  action: "click->chat-hub#selectChat"
                } do %>
            <div class="chat-hub-convo-avatar">
              <div class="chat-agent-indicator">
                <span class="chat-agent-dot"></span>
              </div>
            </div>
            <% last = chat.last_message %>
            <div class="chat-hub-convo-body">
              <div class="chat-hub-convo-top">
                <span class="chat-hub-convo-name"><%= chat.display_name(viewer: Current.user) %><% if chat.direct? && chat.agent&.title.present? %> <span class="chat-hub-convo-title">(<%= chat.agent.title %>)</span><% end %></span>
                <% if last %>
                  <span class="chat-hub-convo-time"><%= time_ago_in_words(last.created_at.in_time_zone(Current.user&.time_zone)) %></span>
                <% end %>
              </div>
              <% if last %>
                <span class="chat-hub-convo-preview"><%= truncate(last.content || "", length: 60) %></span>
              <% end %>
            </div>
            <% if chat.group? %>
              <span class="chat-hub-convo-badge">group</span>
            <% end %>
          <% end %>
        <% end %>
      <% else %>
        <div class="chat-hub-empty-sidebar">
          <p>No chats yet</p>
        </div>
      <% end %>
    </div>
  </div>

  <%# ── Chat Panel ── %>
  <div class="chat-hub-panel" data-chat-hub-target="panel">
    <% if @chat %>
      <div class="chat-page">
        <div class="chat-header">
          <div class="chat-header-left">
            <button type="button" class="chat-back chat-hub-back-btn" data-action="click->chat-hub#showSidebar">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <% if @agent.present? %>
              <%= link_to agent_path(@agent), class: "chat-header-identity", data: { turbo_frame: "_top" } do %>
                <div class="chat-agent-indicator">
                  <span class="chat-agent-dot"></span>
                </div>
                <div>
                  <h1 class="chat-agent-name"><%= @chat.display_name(viewer: Current.user) %><% if @chat.direct? && @agent.title.present? %> <span class="chat-agent-title">(<%= @agent.title %>)</span><% end %></h1>
                </div>
              <% end %>
            <% else %>
              <div class="chat-header-identity">
                <div class="chat-agent-indicator">
                  <span class="chat-agent-dot"></span>
                </div>
                <div>
                  <h1 class="chat-agent-name"><%= @chat.display_name(viewer: Current.user) %></h1>
                </div>
              </div>
            <% end %>
          </div>
          <div class="chat-header-right">
            <% if @agent.present? %>
              <span class="chat-status chat-status-<%= @agent.status %>"><%= @agent.status %></span>
            <% end %>
          </div>
        </div>

        <% if @chat.group? %>
          <div class="chat-participants-bar">
            <div class="chat-participants-list">
              <% @chat.participants.includes(:participatable).each do |participant| %>
                <% entity = participant.participatable %>
                <% next unless entity %>
                <% participant_name = entity.is_a?(User) ? entity.first_name : entity.name %>
                <span class="participant-chip">
                  <%= participant_name %>
                  <%= button_to chat_participant_path(@chat, participant), method: :delete, class: "participant-remove", title: "Remove #{participant_name}" do %>
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 3L9 9M9 3L3 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                  <% end %>
                </span>
              <% end %>
            </div>
            <% if @available_users&.any? %>
              <%= form_with url: chat_participants_path(@chat), class: "participant-add-form" do |f| %>
                <%= f.select :user_id, @available_users.map { |u| [u.first_name, u.id] }, { prompt: "Add..." }, name: "participant[user_id]", class: "participant-add-select", onchange: "this.form.requestSubmit()" %>
              <% end %>
            <% end %>
          </div>
        <% end %>

        <div class="chat-thread" id="chat-thread"
             data-controller="chat-pagination"
             data-chat-pagination-url-value="<%= chat_messages_path(@chat) %>"
        >
          <% if @messages.empty? %>
            <div class="chat-welcome" id="chat-welcome">
              <div class="chat-welcome-icon">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                  <circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="16" cy="16" r="3" fill="currentColor"/>
                  <path d="M16 8V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <path d="M16 20V24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <path d="M8 16H12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <path d="M20 16H24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </div>
              <p class="chat-welcome-text">Begin chatting<% if @agent.present? %> with <strong><%= @agent.name %></strong><% end %></p>
            </div>
          <% end %>

          <div class="chat-messages" id="chat-messages">
            <% if @has_older %>
              <div id="chat-pagination-sentinel" data-chat-pagination-target="sentinel"></div>
            <% end %>
            <% @messages.each do |message| %>
              <%= render "chats/messages/message", message: message, agent: @agent, tts_available: @audio_available %>
            <% end %>
          </div>
        </div>

        <div id="audio-queue" data-controller="audio-queue" style="display:none"></div>

        <% composer_enabled = @agent.nil? || @agent.running? %>
        <div class="chat-composer<%= " chat-composer-disabled" unless composer_enabled %>">
          <% unless composer_enabled %>
            <div class="chat-composer-notice"><%= @agent.name %> is <%= @agent.status %></div>
          <% end %>
          <%= form_with url: chat_messages_path(@chat), class: "chat-composer-form", data: { controller: "chat-composer voice-composer mention", mention_names_value: (@chat.users.map(&:full_name) + @chat.agents.map(&:name)).uniq.to_json, action: "submit->chat-composer#unlockAudio" } do |form| %>
            <div class="chat-composer-inner">
              <% placeholder = if @agent.present?
                composer_enabled ? "Message #{@agent.name}..." : "#{@agent.name} is #{@agent.status}"
              else
                "Message chat..."
              end %>
              <%= form.text_area :content, name: "message[content]", placeholder: placeholder, rows: 1, autofocus: composer_enabled, disabled: !composer_enabled, class: "chat-composer-input", data: { chat_composer_target: "input", mention_target: "input", action: "keydown->mention#onKeydown keydown->chat-composer#submitOnEnter input->mention#onInput input->chat-composer#autoResize" } %>

              <%= form.hidden_field :tts, name: "tts", value: "0", data: { voice_composer_target: "ttsField" } %>
              <%= form.file_field :audio, name: "message[audio]", hidden: true, direct_upload: false, data: { voice_composer_target: "audioField" } %>

              <% if @audio_available %>
                <button type="button" class="chat-composer-btn chat-composer-tts" title="Text-to-speech" data-voice-composer-target="ttsToggle" data-action="click->voice-composer#toggleTts">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                  </svg>
                </button>

                <button type="button" class="chat-composer-btn chat-composer-ptt" title="Push to talk" data-voice-composer-target="recordButton" data-action="click->voice-composer#toggleRecord">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                  </svg>
                </button>
              <% end %>

              <button type="submit" class="chat-composer-send" data-chat-composer-target="button">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                  <path d="M3 9L15 3L9 15L8 10L3 9Z" fill="currentColor"/>
                </svg>
              </button>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="chat-hub-empty">
        <div class="chat-hub-empty-icon">
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
            <path d="M8 10C8 8.89543 8.89543 8 10 8H30C31.1046 8 32 8.89543 32 10V26C32 27.1046 31.1046 28 30 28H22L16 33V28H10C8.89543 28 8 27.1046 8 26V10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="16" cy="18" r="1.5" fill="currentColor"/>
            <circle cx="20" cy="18" r="1.5" fill="currentColor"/>
            <circle cx="24" cy="18" r="1.5" fill="currentColor"/>
          </svg>
        </div>
        <p>Select a chat to start chatting</p>
      </div>
    <% end %>
  </div>
</div>

<div class="agent-profile" data-status="<%= @agent.status %>">
  <%= render "agents/header", active_tab: "settings" %>

  <div class="agent-profile-body">
    <% if flash[:notice] %>
      <div class="flash flash-notice"><%= flash[:notice] %></div>
    <% end %>

    <%= form_with url: agent_settings_path(@agent), method: :patch, data: { controller: "auto-submit", turbo_frame: "_top" } do %>
      <input type="hidden" name="agent[orchestrator]" value="false">
      <label class="switch-label">
        <span class="switch">
          <%= check_box_tag "agent[orchestrator]", "true", @orchestrator, class: "switch-input", data: { action: "auto-submit#submit" } %>
          <span class="switch-track"></span>
        </span>
        <span class="switch-text">
          <span class="switch-title">Orchestrator</span>
          <span class="switch-hint">Enables meta-capabilities like creating and managing other agents.</span>
        </span>
      </label>
    <% end %>

    <%= form_with url: agent_settings_path(@agent), method: :patch, data: { controller: "auto-submit", turbo_frame: "_top" } do %>
      <input type="hidden" name="agent_settings[tts_enabled]" value="false">
      <label class="switch-label">
        <span class="switch">
          <%= check_box_tag "agent_settings[tts_enabled]", "true", @tts_enabled, class: "switch-input", data: { action: "auto-submit#submit" } %>
          <span class="switch-track"></span>
        </span>
        <span class="switch-text">
          <span class="switch-title">Text-to-speech</span>
          <span class="switch-hint">When enabled, this agent's replies can be read aloud.</span>
        </span>
      </label>
    <% end %>

    <div class="settings-section">
      <div class="settings-section-header">
        <h2 class="settings-section-title">Voice & Speech</h2>
      </div>

      <%= form_with url: agent_settings_path(@agent), method: :patch, class: "settings-form", data: { controller: "voice-settings" } do |form| %>
        <div class="form-group">
          <%= form.label :tts_provider, "TTS provider", for: "agent_settings_tts_provider" %>
          <%= form.select :tts_provider,
            options_for_select([
              ["Use account settings", "inherit"],
              ["OpenAI", "openai"],
              ["ElevenLabs", "elevenlabs"]
            ], @tts_provider),
            {}, { name: "agent_settings[tts_provider]", id: "agent_settings_tts_provider", class: "form-select", data: { action: "voice-settings#submitForm" } } %>
        </div>

        <% if @tts_provider == "inherit" %>
          <p class="form-hint">Using account defaults (<%= @effective_tts_provider.capitalize %> / <%= @account_voice || "default voice" %>). <%= link_to "Edit account voice settings", settings_voice_path %>.</p>
        <% else %>
          <% if @effective_tts_provider == "elevenlabs" %>
            <div class="form-group">
              <%= form.label :elevenlabs_model, "ElevenLabs model", for: "agent_settings_elevenlabs_model" %>
              <%= form.select :elevenlabs_model,
                options_for_select(
                  Agent::Audio::ElevenlabsTts::MODELS.map { |id, info|
                    ["#{info[:name]} â€” #{info[:desc]}", id]
                  },
                  @elevenlabs_model
                ),
                {}, { name: "agent_settings[elevenlabs_model]", id: "agent_settings_elevenlabs_model", class: "form-select", data: { action: "voice-settings#submitForm" } } %>
            </div>
          <% end %>

          <div class="form-group">
            <%= form.label :voice, "TTS Voice", for: "agent_settings_voice" %>
            <p class="form-hint">Choose the voice used for text-to-speech audio replies.</p>
            <% if @voices.any? %>
              <div class="voice-options">
                <% @voices.each do |voice| %>
                  <label class="voice-option <%= 'voice-option-selected' if voice[:id] == @current_voice %>">
                    <%= form.radio_button :voice, voice[:id], name: "agent_settings[voice]", id: "voice_#{voice[:id]}", checked: voice[:id] == @current_voice %>
                    <span class="voice-option-name"><%= voice[:name] %></span>
                    <% if voice[:labels].present? %>
                      <span class="voice-option-label"><%= [voice[:labels]["gender"], voice[:labels]["accent"]].compact.join(", ") %></span>
                    <% end %>
                    <% if voice[:preview_url] %>
                      <button type="button" class="voice-preview-btn" data-preview-url="<%= voice[:preview_url] %>" data-action="voice-settings#preview" title="Preview voice">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                      </button>
                    <% end %>
                  </label>
                <% end %>
              </div>
            <% else %>
              <%= form.select :voice,
                options_for_select(Agent::Audio.voices_for(@effective_tts_provider).map { |v| [v.capitalize, v] }, @current_voice),
                { include_blank: "Provider default" },
                { name: "agent_settings[voice]", class: "form-select" } %>
            <% end %>
          </div>

          <% speed_min = @effective_tts_provider == "elevenlabs" ? 0.7 : 0.25 %>
          <% speed_max = @effective_tts_provider == "elevenlabs" ? 1.2 : 4.0 %>
          <% speed_val = @tts_speed.present? ? @tts_speed.to_f : 1.0 %>
          <div class="form-group">
            <%= form.label :tts_speed, "Speaking speed" %>
            <div class="range-with-value">
              <%= form.range_field :tts_speed,
                min: speed_min, max: speed_max, step: 0.05,
                value: speed_val,
                name: "agent_settings[tts_speed]",
                id: "agent_tts_speed_range",
                data: { action: "input->voice-settings#updateSpeed" } %>
              <span data-voice-settings-target="speedValue" class="range-value"><%= format("%.2f", speed_val) %></span>
            </div>
            <p class="form-hint">1.00 is normal. Overrides account default for this agent.</p>
          </div>
        <% end %>

        <div class="form-group">
          <%= form.label :stt_provider, "STT provider", for: "agent_settings_stt_provider" %>
          <%= form.select :stt_provider,
            options_for_select([
              ["Use account settings", "inherit"],
              ["OpenAI Whisper", "openai"],
              ["Local Whisper", "local"]
            ], @stt_provider),
            {}, { name: "agent_settings[stt_provider]", id: "agent_settings_stt_provider", class: "form-select" } %>
        </div>

        <div class="form-actions-inline">
          <%= form.submit "Save", class: "btn btn-primary btn-sm" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

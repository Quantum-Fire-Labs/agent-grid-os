#!/usr/bin/env ruby
# Generates production credentials without booting Rails.
# Used by docker-entrypoint on first boot.

require "securerandom"
require "pathname"
require "active_support/encrypted_configuration"

root = Pathname.new(File.expand_path("..", __dir__))
credentials_dir = root.join("config", "credentials")
credentials_path = credentials_dir.join("production.yml.enc")
key_path = credentials_dir.join("production.key")

exit if credentials_path.exist?

credentials_dir.mkpath

master_key = ENV["RAILS_MASTER_KEY"]
if master_key.blank?
  if key_path.exist?
    master_key = key_path.read.strip
  else
    master_key = SecureRandom.hex(16)
    key_path.write(master_key)
    key_path.chmod(0o600)
  end
end

content = <<~YAML
  secret_key_base: #{SecureRandom.hex(64)}

  active_record_encryption:
    primary_key: #{SecureRandom.alphanumeric(32)}
    deterministic_key: #{SecureRandom.alphanumeric(32)}
    key_derivation_salt: #{SecureRandom.alphanumeric(32)}
YAML

encrypted = ActiveSupport::EncryptedConfiguration.new(
  config_path: credentials_path,
  key_path: key_path,
  env_key: "RAILS_MASTER_KEY",
  raise_if_missing_key: true
)

encrypted.write(content)

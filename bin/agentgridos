#!/usr/bin/env bash
set -euo pipefail

GRID_DIR="/opt/agent-grid-os"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

header()  { echo -e "\n${BOLD}==> $*${RESET}"; }
success() { echo -e "${GREEN}$*${RESET}"; }
warn()    { echo -e "${YELLOW}$*${RESET}"; }
error()   { echo -e "${RED}ERROR: $*${RESET}" >&2; exit 1; }
dim()     { echo -e "${DIM}$*${RESET}"; }

require_root() {
  [[ $EUID -eq 0 ]] || error "Please run as root (sudo agentgridos $1)"
}

# prompt "Label: " varname [-s for silent]
prompt() {
  local label="$1" var="$2" flags="${3:-}"
  read ${flags} -rp "${label}" "${var}"
  [[ "${flags}" == "-s" ]] && echo || true
}

compose() {
  docker compose -f "${GRID_DIR}/docker-compose.yml" --env-file "${GRID_DIR}/.env" "$@"
}

# --- Commands ---

cmd_setup() {
  require_root "setup"

  header "AgentGridOS — Setup"
  echo ""

  # Server hardening
  prompt "Harden server security? (firewall, fail2ban, auto-updates) [Y/n]: " harden
  harden="${harden:-Y}"

  if [[ "${harden}" =~ ^[Yy] ]]; then
    header "Updating system packages"
    apt-get update -qq && apt-get upgrade -y -qq

    header "Configuring firewall"
    apt-get install -y -qq ufw
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp   # SSH
    ufw allow 80/tcp   # HTTP
    ufw allow 443/tcp  # HTTPS
    ufw --force enable
    success "Firewall enabled (ports 22, 80, 443)."

    header "Installing fail2ban"
    apt-get install -y -qq fail2ban
    systemctl enable --now fail2ban
    success "Fail2ban enabled (SSH brute-force protection)."

    header "Enabling automatic security updates"
    apt-get install -y -qq unattended-upgrades
    echo 'Unattended-Upgrade::Automatic-Reboot "false";' > /etc/apt/apt.conf.d/51auto-upgrades
    dpkg-reconfigure -f noninteractive unattended-upgrades
    success "Unattended security upgrades enabled."

    echo ""
    warn "Reminder: For best security, disable SSH password login:"
    warn "  1. Ensure your SSH key is in ~/.ssh/authorized_keys"
    warn "  2. Set 'PasswordAuthentication no' in /etc/ssh/sshd_config"
    warn "  3. Run: systemctl restart sshd"
  fi

  # Configuration
  header "Configuration"
  echo ""

  prompt "Domain name (e.g. grid.example.com): " domain
  [[ -n "${domain}" ]] || error "Domain is required."

  echo ""
  prompt "Admin email: " admin_email
  [[ -n "${admin_email}" ]] || error "Admin email is required."

  while true; do
    prompt "Admin password (min 8 chars): " admin_password -s
    if [[ ${#admin_password} -lt 8 ]]; then
      warn "Password must be at least 8 characters. Try again."
      continue
    fi
    prompt "Confirm password: " admin_password_confirm -s
    if [[ "${admin_password}" != "${admin_password_confirm}" ]]; then
      warn "Passwords do not match. Try again."
      continue
    fi
    break
  done

  echo ""
  prompt "Admin first name [Admin]: " admin_first_name
  admin_first_name="${admin_first_name:-Admin}"

  prompt "Admin last name [User]: " admin_last_name
  admin_last_name="${admin_last_name:-User}"

  # Generate secrets
  master_key=$(openssl rand -hex 16)

  # Write .env
  header "Writing configuration"

  cat > "${GRID_DIR}/.env" <<EOF
DOMAIN=${domain}
RAILS_MASTER_KEY=${master_key}
ADMIN_EMAIL=${admin_email}
ADMIN_PASSWORD=${admin_password}
ADMIN_FIRST_NAME=${admin_first_name}
ADMIN_LAST_NAME=${admin_last_name}
EOF

  # Detect Docker socket GID for container access
  if [[ -S /var/run/docker.sock ]]; then
    echo "DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)" >> "${GRID_DIR}/.env"
  fi

  # Set host storage path for Docker volume mounts
  echo "HOST_STORAGE_PATH=${GRID_DIR}/storage" >> "${GRID_DIR}/.env"

  chmod 600 "${GRID_DIR}/.env"
  success "Configuration saved to ${GRID_DIR}/.env"

  # Launch
  header "Starting AgentGridOS"

  # Pull workspace image
  header "Pulling workspace image"
  docker pull ghcr.io/quantum-fire-labs/agent-grid-os/workspace:latest

  compose pull
  compose up -d

  echo ""
  success "AgentGridOS is running!"
  echo ""
  echo "  URL:   https://${domain}"
  echo "  Login: ${admin_email}"
  echo ""
  dim "It may take a minute for SSL certificates to provision."
  dim "Logs: agentgridos logs"
}

cmd_start() {
  require_root "start"
  header "Starting AgentGridOS"
  compose up -d
  success "AgentGridOS is running."
}

cmd_stop() {
  require_root "stop"
  header "Stopping AgentGridOS"
  compose down
  success "AgentGridOS is stopped."
}

cmd_update() {
  require_root "update"
  header "Updating AgentGridOS"
  git -C "${GRID_DIR}" pull --ff-only

  # Backfill HOST_STORAGE_PATH and DOCKER_GID if missing
  if [[ -f "${GRID_DIR}/.env" ]]; then
    if ! grep -q '^HOST_STORAGE_PATH=' "${GRID_DIR}/.env"; then
      echo "HOST_STORAGE_PATH=${GRID_DIR}/storage" >> "${GRID_DIR}/.env"
      dim "Added HOST_STORAGE_PATH to .env"
    fi
    if ! grep -q '^DOCKER_GID=' "${GRID_DIR}/.env" && [[ -S /var/run/docker.sock ]]; then
      echo "DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)" >> "${GRID_DIR}/.env"
      dim "Added DOCKER_GID to .env"
    fi
  fi

  # Pull workspace image
  header "Pulling workspace image"
  docker pull ghcr.io/quantum-fire-labs/agent-grid-os/workspace:latest

  compose pull
  compose up -d
  success "AgentGridOS is updated and running."
}

cmd_logs() {
  compose logs -f "$@"
}

cmd_help() {
  echo ""
  echo -e "${BOLD}AgentGridOS${RESET} — Self-hosted AI agent platform"
  echo ""
  echo "Usage: agentgridos <command>"
  echo ""
  echo "Commands:"
  echo "  setup    Interactive first-time setup"
  echo "  start    Start all services"
  echo "  stop     Stop all services"
  echo "  update   Pull latest changes and restart"
  echo "  logs     Follow container logs"
  echo "  help     Show this help"
  echo ""
}

# --- Dispatch ---

command="${1:-help}"
shift || true

case "${command}" in
  setup)  cmd_setup ;;
  start)  cmd_start ;;
  stop)   cmd_stop ;;
  update) cmd_update ;;
  logs)   cmd_logs "$@" ;;
  help|--help|-h) cmd_help ;;
  *)
    error "Unknown command: ${command}\nRun 'agentgridos help' for usage."
    ;;
esac
